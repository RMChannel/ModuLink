<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Modifica Profilo - ModuLink</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/user/colors.css}">
    <link rel="stylesheet" th:href="@{/css/user/dashboard-layout.css}">
    <link rel="stylesheet" th:href="@{/css/user/edit-profile.css}">
    <link rel="stylesheet" th:href="@{/css/common/alerts.css}">
    <script th:src="@{/javascript/theme.js}"></script>
</head>
<body>
<div class="dashboard-wrapper">
    <!-- Sidebar Fragment -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>
    <div th:replace="~{fragments/messages :: alerts}"></div>

    <!-- Main Content -->
    <div id="content" class="p-4">
        <div class="container-fluid">
            <div class="d-flex align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="bi bi-person-gear me-2 text-primary"></i>Modifica Profilo
                </h2>
            </div>
            
            <div class="card shadow edit-profile-card border-0" style="background-color: var(--bg-white); color: var(--text-body);">
                <div class="profile-header">
                    <div class="profile-img-container">
                        <div class="profile-img-wrapper" id="profileImageWrapper">
                            <!-- Image Element (Always present, toggled visibility) -->
                            <img id="profilePreview" 
                                 th:src="${utente.path_immagine_profilo != null and !utente.path_immagine_profilo.empty} ? @{'/'+${utente.path_immagine_profilo}} : ''"
                                 th:style="${utente.path_immagine_profilo != null and !utente.path_immagine_profilo.empty} ? 'display:block' : 'display:none'"
                                 alt="Profile Image">
                            
                            <!-- Placeholder (Always present, toggled visibility) -->
                            <div id="placeholderIcon" class="profile-img-placeholder"
                                 th:style="${utente.path_immagine_profilo != null and !utente.path_immagine_profilo.empty} ? 'display:none' : 'display:flex'">
                                <i class="bi bi-person"></i>
                            </div>
                        </div>

                        <!-- Remove Button (Moved outside wrapper) -->
                        <button type="button" class="remove-img-btn" id="removeImgBtn" 
                                th:classappend="${utente.path_immagine_profilo != null and !utente.path_immagine_profilo.empty} ? 'has-image' : ''"
                                title="Rimuovi immagine">
                            <i class="bi bi-x"></i>
                        </button>

                        <!-- Edit Button (Moved outside wrapper) -->
                        <label for="immagineFile" class="img-edit-btn">
                            <i class="bi bi-camera-fill"></i>
                        </label>
                    </div>
                </div>

                <div class="card-body p-4 pt-5">
                    <form th:action="@{/dashboard/update-user}" th:object="${editUserForm}" method="post" enctype="multipart/form-data">
                        <!-- Hidden inputs for image management -->
                        <input type="file" id="immagineFile" th:field="*{immagineProfilo}" accept="image/*" style="display: none;">
                        <input type="hidden" id="removeImageFlag" name="removeImageFlag" value="false">
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <h4 class="form-section-title">Informazioni Personali</h4>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="nome" class="form-label">Nome</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-person"></i></span>
                                    <input type="text" class="form-control" id="nome" th:field="*{nome}" 
                                           th:classappend="${#fields.hasErrors('nome')} ? 'is-invalid' : ''" required>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('nome')}" th:errors="*{nome}"></div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cognome" class="form-label">Cognome</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
                                    <input type="text" class="form-control" id="cognome" th:field="*{cognome}" 
                                           th:classappend="${#fields.hasErrors('cognome')} ? 'is-invalid' : ''" required>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('cognome')}" th:errors="*{cognome}"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email (Non modificabile)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                    <input type="email" class="form-control" id="email" th:field="*{email}" th:classappend="${#fields.hasErrors('email')} ? 'is-invalid' : ''" readonly style="background-color: var(--bg-body-alt); color: var(--text-secondary);">
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="telefono" class="form-label">Telefono</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                                    <input type="tel" class="form-control" id="telefono" th:field="*{telefono}" 
                                           th:classappend="${#fields.hasErrors('telefono')} ? 'is-invalid' : ''" required>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('telefono')}" th:errors="*{telefono}"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <h4 class="form-section-title">Sicurezza</h4>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="password" class="form-label">Nuova Password</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-lock"></i></span>
                                    <input type="password" class="form-control" id="password" th:field="*{password}"
                                           th:classappend="${#fields.hasErrors('password')} ? 'is-invalid' : ''" placeholder="Lascia vuoto per non modificare">
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="confirmPassword" class="form-label">Conferma Password</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                                    <input type="password" class="form-control" id="confirmPassword" th:field="*{confirmPassword}"
                                           th:classappend="${#fields.hasErrors('confirmPassword')} ? 'is-invalid' : ''" placeholder="Conferma la nuova password">
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('confirmPassword')}" th:errors="*{confirmPassword}"></div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <a th:href="@{/dashboard}" class="btn btn-outline-secondary me-2 px-4">Annulla</a>
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="bi bi-check2-circle me-1"></i>Salva Modifiche
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('immagineFile');
    const preview = document.getElementById('profilePreview');
    const placeholder = document.getElementById('placeholderIcon');
    const removeBtn = document.getElementById('removeImgBtn');
    const removeFlag = document.getElementById('removeImageFlag');

    fileInput.onchange = evt => {
        const [file] = fileInput.files;
        if (file) {
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
            if (placeholder) placeholder.style.display = 'none';
            
            removeBtn.classList.add('has-image');
            removeFlag.value = "false";
        }
    }

    removeBtn.onclick = () => {
        fileInput.value = "";
        preview.src = "";
        preview.style.display = 'none';
        
        if (placeholder) {
            placeholder.style.display = 'flex';
        }
        
        removeBtn.classList.remove('has-image');
        removeFlag.value = "true";
    }
</script>

<!-- Bootstrap JavaScript Bundle (include Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
