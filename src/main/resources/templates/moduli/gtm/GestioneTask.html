<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Gestione Task - ModuLink</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/user/colors.css}">
    <link rel="stylesheet" th:href="@{/css/user/dashboard-layout.css}">
    <link rel="stylesheet" th:href="@{/css/moduli/gtm/gtm.css}">
    <link rel="stylesheet" th:href="@{/css/common/alerts.css}">
    <script th:src="@{/javascript/theme.js}"></script>
</head>
<body>
<div class="dashboard-wrapper">
    <!-- Sidebar Fragment -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>
    
    <!-- Alerts Fragment -->
    <div th:replace="~{fragments/messageFromParam :: alertsFromParam}"></div>

    <!-- Main Content -->
    <div id="content">
        <div class="container-fluid">
            <!-- Header -->
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-5 pt-md-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Gestione Task</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button type="button" class="btn btn-sm btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                        <i class="bi bi-plus-lg"></i> Nuova Task
                    </button>
                </div>
            </div>

            <!-- Section 1: Task create da me -->
            <div class="d-flex align-items-center mb-3">
                <i class="bi bi-person-workspace me-2 fs-4 text-primary"></i>
                <h3 class="mb-0">Le mie Task</h3>
            </div>
            
            <div class="card shadow-sm border-0 rounded-4 overflow-hidden mb-5">
                <div class="table-responsive">
                    <table class="table table-hover table-borderless align-middle mb-0">
                        <thead class="table-light border-bottom">
                        <tr>
                            <th scope="col" class="ps-4">Titolo</th>
                            <th scope="col">Priorità</th>
                            <th scope="col">Data Creazione</th>
                            <th scope="col">Scadenza</th>
                            <th scope="col">Completamento</th>
                            <th scope="col" class="text-end pe-4">Azioni</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="task : ${taskCreate}">
                            <td class="ps-4 fw-medium" th:text="${task.titolo}">Titolo Task</td>
                            <td>
                                <span th:text="${task.priorita}"
                                      th:class="'badge rounded-pill ' + (${task.priorita} >= 4 ? 'bg-danger bg-opacity-10 text-danger' : (${task.priorita} >= 2 ? 'bg-warning bg-opacity-10 text-warning' : 'bg-info bg-opacity-10 text-info'))">
                                    1
                                </span>
                            </td>
                            <td class="text-muted small" th:text="${#temporals.format(task.dataCreazione, 'dd/MM/yyyy')}">01/01/2024</td>
                            <td class="text-muted small" th:text="${task.scadenza != null ? #temporals.format(task.scadenza, 'dd/MM/yyyy') : '-'}">01/01/2024</td>
                            <td>
                                <span th:if="${task.dataCompletamento != null}" class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">Completata</span>
                                <span th:unless="${task.dataCompletamento != null}" class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25">In corso</span>
                            </td>
                            <td class="text-end pe-4">
                                <div class="d-flex justify-content-end gap-2">
                                    <!-- Edit Button -->
                                    <button class="btn btn-sm btn-light text-primary border-0 btn-edit-task" 
                                            title="Modifica"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editTaskModal"
                                            th:data-id="${task.id_task}"
                                            th:data-titolo="${task.titolo}"
                                            th:data-priorita="${task.priorita}"
                                            th:data-scadenza="${task.scadenza}"
                                            th:data-completato="${task.dataCompletamento != null}"
                                            th:data-assignees="${task.assegnazioni != null ? '[' + #strings.listJoin(task.assegnazioni.![ '{&quot;id&quot;:' + utente.id_utente + ',&quot;type&quot;:&quot;utente&quot;,&quot;nome&quot;:&quot;' + utente.email + '&quot;,&quot;color&quot;:&quot;#4287f5&quot;}' ], ',') + ']' : '[]'}"
                                            >
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    
                                    <!-- Delete Form -->
                                    <form th:action="@{/dashboard/gtm/delete-task}" method="post" onsubmit="return confirm('Sei sicuro di voler eliminare questa task?');">
                                        <input type="hidden" name="idTask" th:value="${task.id_task}">
                                        <button type="submit" class="btn btn-sm btn-light text-danger border-0" title="Elimina">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        <tr th:if="${taskCreate == null or #lists.isEmpty(taskCreate)}">
                            <td colspan="6" class="text-center text-muted py-5">
                                <i class="bi bi-clipboard-plus display-6 d-block mb-3 opacity-50"></i>
                                <em>Non hai creato nessuna task.</em>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Section 2: Task assegnate a me -->
            <div class="d-flex align-items-center mb-3">
                <i class="bi bi-clipboard-check me-2 fs-4 text-success"></i>
                <h3 class="mb-0">Task Assegnate</h3>
            </div>
            
            <div class="card shadow-sm border-0 rounded-4 overflow-hidden mb-5">
                <div class="table-responsive">
                    <table class="table table-hover table-borderless align-middle mb-0">
                        <thead class="table-light border-bottom">
                        <tr>
                            <th scope="col" class="ps-4">Titolo</th>
                            <th scope="col">Creatore</th>
                            <th scope="col">Priorità</th>
                            <th scope="col">Scadenza</th>
                            <th scope="col">Stato</th>
                            <th scope="col" class="text-end pe-4">Azioni</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="task : ${taskAssegnate}">
                            <td class="ps-4 fw-medium" th:text="${task.titolo}">Titolo Task</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2 small" style="width: 24px; height: 24px;">
                                        <i class="bi bi-person-fill" style="font-size: 0.8rem;"></i>
                                    </div>
                                    <span th:text="${task.utenteCreatore.nome} + ' ' + ${task.utenteCreatore.cognome}">Mario Rossi</span>
                                </div>
                            </td>
                            <td>
                                 <span th:text="${task.priorita}"
                                       th:class="'badge rounded-pill ' + (${task.priorita} >= 4 ? 'bg-danger bg-opacity-10 text-danger' : (${task.priorita} >= 2 ? 'bg-warning bg-opacity-10 text-warning' : 'bg-info bg-opacity-10 text-info'))">
                                    1
                                </span>
                            </td>
                            <td class="text-muted small" th:text="${task.scadenza != null ? #temporals.format(task.scadenza, 'dd/MM/yyyy') : '-'}">01/01/2024</td>
                            <td>
                                <span th:if="${task.dataCompletamento != null}" class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">Completata</span>
                                <span th:unless="${task.dataCompletamento != null}" class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25">Da Fare</span>
                            </td>
                            <td class="text-end pe-4">
                                 <div class="d-flex justify-content-end gap-2">
                                     <!-- Mark as Completed Form -->
                                     <form th:if="${task.dataCompletamento == null}" th:action="@{/dashboard/gtm/set-as-completato}" method="post">
                                         <input type="hidden" name="idTask" th:value="${task.id_task}">
                                         <button type="submit" class="btn btn-sm btn-light text-success border-0" title="Segna come completata">
                                             <i class="bi bi-check-lg"></i>
                                         </button>
                                     </form>
                                     
                                     <button class="btn btn-sm btn-light text-secondary border-0" title="Visualizza (Coming Soon)" disabled>
                                        <i class="bi bi-eye"></i>
                                    </button>
                                 </div>
                            </td>
                        </tr>
                        <tr th:if="${taskAssegnate == null or #lists.isEmpty(taskAssegnate)}">
                            <td colspan="6" class="text-center text-muted py-5">
                                <i class="bi bi-check2-circle display-6 d-block mb-3 opacity-50"></i>
                                <em>Non ci sono task assegnate a te al momento.</em>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade gtm-modal" id="addTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form th:action="@{/dashboard/gtm}" method="post" th:object="${form}">
                <div class="modal-header">
                    <h5 class="modal-title">Nuova Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Title -->
                    <div class="mb-3">
                        <label for="titolo" class="form-label">Titolo</label>
                        <input type="text" class="form-control" id="titolo" name="titolo" th:value="*{titolo}" th:classappend="${#fields.hasErrors('titolo')} ? 'is-invalid' : ''" placeholder="Titolo della task" required minlength="2" maxlength="50">
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('titolo')}" th:errors="*{titolo}">Errore titolo</div>
                        <div class="form-text" th:unless="${#fields.hasErrors('titolo')}">Minimo 2 caratteri, massimo 50.</div>
                    </div>

                    <!-- Priority & Deadline Row -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="priorita" class="form-label">Priorità</label>
                            <select class="form-select" id="priorita" name="priorita" th:value="*{priorita}" th:classappend="${#fields.hasErrors('priorita')} ? 'is-invalid' : ''">
                                <option value="1" th:selected="*{priorita == 1}">Bassa (1)</option>
                                <option value="2" th:selected="*{priorita == 2}">Medio-Bassa (2)</option>
                                <option value="3" th:selected="*{priorita == 3}">Normale (3)</option>
                                <option value="4" th:selected="*{priorita == 4}">Alta (4)</option>
                                <option value="5" th:selected="*{priorita == 5}">Urgente (5)</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('priorita')}" th:errors="*{priorita}">Errore priorità</div>
                        </div>
                        <div class="col-md-6">
                            <label for="scadenza" class="form-label">Scadenza</label>
                            <input type="date" class="form-control" id="scadenza" name="scadenza" th:value="*{scadenza}" th:classappend="${#fields.hasErrors('scadenza')} ? 'is-invalid' : ''">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('scadenza')}" th:errors="*{scadenza}">Errore scadenza</div>
                        </div>
                    </div>
                    
                    <!-- Assignee Selection (Multiple) -->
                    <div class="mb-3">
                        <label class="form-label">Assegna a</label>
                        
                        <!-- Selected Assignees Container (Chips) -->
                        <div id="add_selectedAssigneesList" class="d-flex flex-wrap gap-2 mb-2"></div>
                        
                        <!-- Search Input -->
                        <div class="position-relative">
                            <div class="input-group">
                                <span class="input-group-text border-end-0"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control border-start-0 ps-0" id="add_searchAssignee" placeholder="Cerca utente o ruolo..." autocomplete="off">
                            </div>
                            
                            <!-- Dropdown list -->
                            <div id="add_assigneeDropdown" class="list-group position-absolute w-100 shadow-sm mt-1 overflow-auto rounded-3 border" style="max-height: 250px; z-index: 1050; display: none;"></div>
                        </div>
                        
                        <!-- Container for dynamically generated hidden inputs -->
                        <div id="add_hiddenInputsContainer"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Crea Task</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade gtm-modal" id="editTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form th:action="@{/dashboard/gtm/edit-task}" id ="modify_task" method="post" th:object="${editForm}">
                <input type="hidden" id="edit_idTask" name="idTask" th:value="*{idTask}">
                <div class="modal-header">
                    <h5 class="modal-title">Modifica Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Title -->
                    <div class="mb-3">
                        <label for="edit_titolo" class="form-label">Titolo</label>
                        <input type="text" class="form-control" id="edit_titolo" name="titolo" th:value="*{titolo}" th:classappend="${#fields.hasErrors('titolo')} ? 'is-invalid' : ''" placeholder="Titolo della task" required minlength="2" maxlength="50">
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('titolo')}" th:errors="*{titolo}">Errore titolo</div>
                    </div>

                    <!-- Priority & Deadline Row -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="edit_priorita" class="form-label">Priorità</label>
                            <select class="form-select" id="edit_priorita" name="priorita" th:value="*{priorita}" th:classappend="${#fields.hasErrors('priorita')} ? 'is-invalid' : ''">
                                <option value="1" th:selected="*{priorita == 1}">Bassa (1)</option>
                                <option value="2" th:selected="*{priorita == 2}">Medio-Bassa (2)</option>
                                <option value="3" th:selected="*{priorita == 3}">Normale (3)</option>
                                <option value="4" th:selected="*{priorita == 4}">Alta (4)</option>
                                <option value="5" th:selected="*{priorita == 5}">Urgente (5)</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('priorita')}" th:errors="*{priorita}">Errore priorità</div>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_scadenza" class="form-label">Scadenza</label>
                            <input type="date" class="form-control" id="edit_scadenza" name="scadenza" th:value="*{scadenza}" th:classappend="${#fields.hasErrors('scadenza')} ? 'is-invalid' : ''">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('scadenza')}" th:errors="*{scadenza}">Errore scadenza</div>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="edit_completato" name="completato" th:checked="*{completato}">
                        <label class="form-check-label" for="edit_completato">Segna come completata</label>
                    </div>
                    
                    <!-- Assignee Selection (Multiple) -->
                    <div class="mb-3">
                        <label class="form-label">Assegnatari</label>
                        
                        <!-- Selected Assignees Container (Chips) -->
                        <div id="edit_selectedAssigneesList" class="d-flex flex-wrap gap-2 mb-2"></div>
                        
                        <!-- Search Input -->
                        <div class="position-relative">
                            <div class="input-group">
                                <span class="input-group-text border-end-0"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control border-start-0 ps-0" id="edit_searchAssignee" placeholder="Cerca utente o ruolo..." autocomplete="off">
                            </div>
                            
                            <!-- Dropdown list -->
                            <div id="edit_assigneeDropdown" class="list-group position-absolute w-100 shadow-sm mt-1 overflow-auto rounded-3 border" style="max-height: 250px; z-index: 1050; display: none;"></div>
                        </div>
                        
                        <!-- Container for dynamically generated hidden inputs -->
                        <div id="edit_hiddenInputsContainer"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary" >Salva Modifiche</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
class AssigneeManager {
    constructor(prefix) {
        this.prefix = prefix;
        this.searchInput = document.getElementById(prefix + '_searchAssignee');
        this.dropdown = document.getElementById(prefix + '_assigneeDropdown');
        this.selectedList = document.getElementById(prefix + '_selectedAssigneesList');
        this.hiddenInputsContainer = document.getElementById(prefix + '_hiddenInputsContainer');
        
        this.availableAssignees = []; // Data from server
        this.selectedAssignees = [];  // Currently selected
        
        this.init();
    }

    init() {
        // Search Input Events
        this.searchInput.addEventListener('input', () => this.filterList());
        this.searchInput.addEventListener('focus', () => this.filterList());
        this.searchInput.addEventListener('click', () => this.filterList()); // Fix: Re-open on click if already focused
        
        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            if (!this.searchInput.contains(e.target) && !this.dropdown.contains(e.target)) {
                this.dropdown.style.display = 'none';
            }
        });
    }

    loadData(data) {
        this.availableAssignees = data;
    }
    
    setSelection(selection) {
        this.selectedAssignees = selection ? [...selection] : [];
        this.updateUI();
    }
    
    clearSelection() {
        this.selectedAssignees = [];
        this.updateUI();
    }

    renderList(items) {
        this.dropdown.innerHTML = '';
        if (items.length === 0) {
            this.dropdown.style.display = 'none';
            return;
        }
        
        items.forEach(item => {
            // Skip if already selected
            if (this.selectedAssignees.some(s => s.id === item.id && s.type === item.type)) {
                return;
            }

            const a = document.createElement('a');
            a.className = 'list-group-item list-group-item-action d-flex align-items-center';
            
            // Icon based on type
            const iconClass = item.type === 'utente' ? 'bi-person-fill' : 'bi-people-fill';
            
            a.innerHTML = `
                <div class="d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px; background-color: ${item.color || '#eee'}; border-radius: 50%;">
                    <i class="bi ${iconClass} text-white"></i>
                </div>
                <span>${item.nome}</span>
            `;
            
            a.addEventListener('click', (e) => {
                e.preventDefault();
                this.addAssignee(item);
            });
            
            this.dropdown.appendChild(a);
        });
        
        if (this.dropdown.childElementCount === 0) {
            this.dropdown.style.display = 'none';
        } else {
             this.dropdown.style.display = 'block';
        }
    }
    
    filterList() {
        const query = this.searchInput.value.toLowerCase();
        let filtered = this.availableAssignees;
        if (query.length > 0) {
            filtered = this.availableAssignees.filter(item => item.nome.toLowerCase().includes(query));
        }
        this.renderList(filtered);
    }

    addAssignee(item) {
        this.selectedAssignees.push(item);
        this.updateUI();
        this.searchInput.value = '';
        this.searchInput.focus();
        this.dropdown.style.display = 'none';
    }

    removeAssignee(index) {
        this.selectedAssignees.splice(index, 1);
        this.updateUI();
    }

    updateUI() {
        // 1. Render Chips
        this.selectedList.innerHTML = '';
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        
        this.selectedAssignees.forEach((item, index) => {
            const chip = document.createElement('div');
            // Use custom class 'assignee-chip' instead of 'bg-light' and inline border styles
            chip.className = 'd-flex align-items-center rounded-pill pe-2 ps-1 py-1 assignee-chip';
            
            const iconClass = item.type === 'utente' ? 'bi-person-fill' : 'bi-people-fill';
            const closeBtnClass = isDark ? 'btn-close btn-close-white' : 'btn-close';
            
            chip.innerHTML = `
                <div class="d-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px; background-color: ${item.color || '#6c757d'}; border-radius: 50%;">
                    <i class="bi ${iconClass} text-white" style="font-size: 0.8rem;"></i>
                </div>
                <span class="me-2 fw-medium" style="font-size: 0.9rem;">${item.nome}</span>
                <button type="button" class="${closeBtnClass}" style="font-size: 0.7em;" aria-label="Remove"></button>
            `;
            
            chip.querySelector('.btn-close').addEventListener('click', () => this.removeAssignee(index));
            this.selectedList.appendChild(chip);
        });

        // 2. Update Hidden Inputs for Spring Binding
        this.hiddenInputsContainer.innerHTML = '';
        this.selectedAssignees.forEach((item, index) => {
            this.createHiddenInput(index, 'id', item.id);
            this.createHiddenInput(index, 'type', item.type);
            this.createHiddenInput(index, 'nome', item.nome);
            this.createHiddenInput(index, 'color', item.color);
            this.createHiddenInput(index, 'azienda', item.azienda);
        });
    }

    createHiddenInput(index, field, value) {
        if (value === undefined || value === null) return;
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = `messaggi[${index}].${field}`;
        input.value = value;
        this.hiddenInputsContainer.appendChild(input);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    let globalAssigneesData = [];
    
    // Initialize Managers
    const addManager = new AssigneeManager('add');
    const editManager = new AssigneeManager('edit');

    // Fetch assignees once and share
    fetch('/dashboard/gtm/getusers', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            globalAssigneesData = data;
            addManager.loadData(data);
            editManager.loadData(data);
        })
        .catch(err => console.error('Error fetching assignees:', err));

    // Add Modal Events
    const addModal = document.getElementById('addTaskModal');
    addModal.addEventListener('show.bs.modal', function () {
        addManager.clearSelection();
        document.getElementById('add_searchAssignee').value = '';
    });

    // Check for errors and reopen modals if necessary
    if (document.querySelector('#addTaskModal .is-invalid')) {
        new bootstrap.Modal(addModal).show();
    }
    if (document.querySelector('#editTaskModal .is-invalid')) {
        new bootstrap.Modal(document.getElementById('editTaskModal')).show();
    }

    // Edit Modal Events & Pre-filling
    const editModal = document.getElementById('editTaskModal');
    // Using event delegation for edit buttons to handle dynamically created rows if any (though here they are server-side)
    document.querySelectorAll('.btn-edit-task').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const titolo = this.getAttribute('data-titolo');
            const priorita = this.getAttribute('data-priorita');
            const scadenza = this.getAttribute('data-scadenza');
            const completato = this.getAttribute('data-completato') === 'true';
            
            // Parse assignees JSON
            let assignees = [];
            try {
                assignees = JSON.parse(this.getAttribute('data-assignees'));
            } catch (e) {
                console.error("Error parsing assignees", e);
            }

            // Fill Form
            document.getElementById('edit_idTask').value = id;
            document.getElementById('edit_titolo').value = titolo;
            document.getElementById('edit_priorita').value = priorita;
            document.getElementById('edit_scadenza').value = scadenza;
            document.getElementById('edit_completato').checked = completato;
            
            // Populate Manager
            editManager.setSelection(assignees);
        });
    });
});

</script>
</body>
</html>