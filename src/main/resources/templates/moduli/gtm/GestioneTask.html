<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Gestione Task - ModuLink</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/user/colors.css}">
    <link rel="stylesheet" th:href="@{/css/user/dashboard-layout.css}">
    <link rel="stylesheet" th:href="@{/css/moduli/gtm/gtm.css}">
    <link rel="stylesheet" th:href="@{/css/common/alerts.css}">
    <script th:src="@{/javascript/theme.js}"></script>
    <style>
        /* =========================================
           STRICT THEME ADHERENCE & RESPONSIVE CSS
           ========================================= */

        /* General Layout Fixes */
        body {
            background-color: var(--bg-body);
            color: var(--text-body);
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--text-heading);
        }

        /* 
           Responsive Grid Card 
           Using border-left instead of absolute positioning for stability 
        */
        .task-card {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-left-width: 6px; /* Priority Indicator */
            border-radius: 0.75rem;
            box-shadow: var(--shadow-card);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .task-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-card-hover);
            border-top-color: var(--border-color-hover);
            border-right-color: var(--border-color-hover);
            border-bottom-color: var(--border-color-hover);
        }

        .task-card-body {
            padding: 1.25rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Priority Border Colors Mapping */
        .priority-border-1, .priority-border-2 { border-left-color: var(--text-muted); }
        .priority-border-3 { border-left-color: var(--color-primary-lighter); }
        .priority-border-4 { border-left-color: var(--color-primary); }
        .priority-border-5 { border-left-color: var(--text-danger); }

        /* Typography & Elements */
        .text-theme-secondary { color: var(--text-secondary) !important; }
        .text-theme-muted { color: var(--text-muted) !important; }
        .text-theme-heading { color: var(--text-heading) !important; }
        
        .bg-theme-alt { background-color: var(--bg-body-alt); }

        /* Custom Badge */
        .badge-theme {
            font-weight: 600;
            padding: 0.5em 0.75em;
            border-radius: 50rem;
            font-size: 0.75rem;
            letter-spacing: 0.02em;
        }
        .badge-theme-primary { background-color: var(--color-primary-light); color: var(--color-primary); }
        .badge-theme-danger { background-color: var(--bg-alert-danger); color: var(--text-danger); border: 1px solid var(--border-alert-danger); }
        .badge-theme-muted { background-color: var(--bg-body-alt); color: var(--text-secondary); border: 1px solid var(--border-color); }

        /* Buttons */
        .btn-theme-primary {
            background-color: var(--color-primary);
            color: var(--color-white);
            border: none;
            box-shadow: var(--shadow-btn-primary);
            padding: 0.5rem 1.25rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-theme-primary:hover {
            background-color: var(--color-primary-dark);
            color: var(--color-white);
        }
        
        .btn-icon-circle {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .btn-icon-circle:hover {
            background-color: var(--bg-body-alt);
            color: var(--color-primary);
            border-color: var(--color-primary);
        }
        .btn-icon-circle.danger:hover {
            color: var(--text-danger);
            border-color: var(--text-danger);
            background-color: var(--bg-alert-danger);
        }

        /* Inputs (Theme Aware) */
        .form-control-theme, .form-select-theme {
            background-color: var(--bg-input);
            color: var(--text-body);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
        }
        .form-control-theme:focus, .form-select-theme:focus {
            background-color: var(--bg-input-focus);
            border-color: var(--border-focus);
            box-shadow: var(--shadow-input-focus);
            color: var(--text-body);
        }

        /* Empty State */
        .empty-state-box {
            background-color: var(--bg-module-card);
            border: 2px dashed var(--border-color);
            border-radius: 1rem;
            padding: 3rem 1rem;
            text-align: center;
        }

        /* Modals */
        .modal-content-theme {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
        }
        .modal-header-theme {
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem;
        }
        .modal-body-theme {
            padding: 1.5rem;
        }
        .modal-footer-theme {
            border-top: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            .page-header .btn-toolbar {
                width: 100%;
            }
            .page-header .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
<div class="dashboard-wrapper">
    <!-- Sidebar Fragment -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <!-- Alerts Fragment -->
    <div th:replace="~{fragments/messageFromParam :: alertsFromParam}"></div>

    <!-- Main Content -->
    <div id="content">
        <div class="container-fluid px-3 px-md-4">
            
            <!-- Page Header -->
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-5 pt-md-4 pb-4 mb-4 border-bottom page-header" style="border-color: var(--border-color) !important;">
                <div class="d-flex align-items-center">
                    <h1 class="h2 fw-bold text-theme-heading mb-0">Gestione Task</h1>
                </div>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button type="button" class="btn btn-theme-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                        <i class="bi bi-plus-lg me-2"></i>Nuova Task
                    </button>
                </div>
            </div>

            <!-- SECTION 1: LE MIE TASK -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background-color: var(--bg-body-alt);">
                            <i class="bi bi-person-workspace text-theme-heading fs-5"></i>
                        </div>
                        <h4 class="mb-0 fw-bold text-theme-heading">Le mie Task</h4>
                        <span class="badge badge-theme-primary ms-3" th:text="${taskCreate != null ? taskCreate.size() : 0}">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Grid: Le mie Task -->
            <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3 g-xl-4 mb-5">
                <!-- Loop Items -->
                <div class="col" th:each="task : ${taskCreate}">
                    <div class="task-card" th:classappend="'priority-border-' + ${task.priorita}">
                        <div class="task-card-body">
                            <!-- Header: Title & Status -->
                            <div class="d-flex justify-content-between align-items-start gap-2">
                                <h5 class="fw-bold text-theme-heading text-truncate mb-0" th:title="${task.titolo}" th:text="${task.titolo}" style="max-width: 70%;">Task Title</h5>
                                
                                <span th:if="${task.priorita <= 2}" class="badge badge-theme-muted flex-shrink-0">Bassa</span>
                                <span th:if="${task.priorita == 3}" class="badge badge-theme-primary flex-shrink-0">Normale</span>
                                <span th:if="${task.priorita >= 4}" class="badge badge-theme-danger flex-shrink-0">Alta</span>
                            </div>

                            <!-- Meta Info -->
                            <div class="d-flex flex-column gap-2 mt-2">
                                <div class="d-flex align-items-center text-theme-secondary small">
                                    <i class="bi bi-calendar-event me-2"></i>
                                    <span>Creato: <strong th:text="${#temporals.format(task.dataCreazione, 'dd/MM/yyyy')}"></strong></span>
                                </div>
                                <div class="d-flex align-items-center text-theme-secondary small">
                                    <i class="bi bi-clock-history me-2"></i>
                                    <span>Scadenza: <strong th:text="${task.scadenza != null ? #temporals.format(task.scadenza, 'dd/MM/yyyy') : 'N/A'}"></strong></span>
                                </div>
                            </div>

                            <!-- Spacer -->
                            <div class="flex-grow-1"></div>

                            <!-- Footer: Status & Actions -->
                            <div class="pt-3 border-top d-flex justify-content-between align-items-center" style="border-color: var(--border-color) !important;">
                                <!-- Status Pill -->
                                <div>
                                    <span th:if="${task.dataCompletamento != null}" class="badge rounded-pill" style="background-color: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2);">
                                        <i class="bi bi-check2-circle me-1"></i> Completata
                                    </span>
                                    <span th:unless="${task.dataCompletamento != null}" class="badge rounded-pill" style="background-color: var(--bg-body-alt); color: var(--text-secondary);">
                                        <i class="bi bi-circle me-1"></i> In corso
                                    </span>
                                </div>

                                <!-- Actions -->
                                <div class="d-flex gap-2">
                                    <button class="btn-icon-circle btn-edit-task" 
                                            title="Modifica"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editTaskModal"
                                            th:data-id="${task.id_task}"
                                            th:data-titolo="${task.titolo}"
                                            th:data-priorita="${task.priorita}"
                                            th:data-scadenza="${task.scadenza}"
                                            th:data-completato="${task.dataCompletamento != null}"
                                            th:data-assignees="${task.assegnazioni != null ? '[' + #strings.listJoin(task.assegnazioni.![ '{&quot;id&quot;:' + utente.id_utente + ',&quot;type&quot;:&quot;utente&quot;,&quot;nome&quot;:&quot;' + utente.email + '&quot;,&quot;color&quot;:&quot;#4287f5&quot;}' ], ',') + ']' : '[]'}">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    
                                    <button type="button" class="btn-icon-circle danger" title="Elimina"
                                            th:data-id="${task.id_task}"
                                            th:data-titolo="${task.titolo}"
                                            onclick="openDeleteTaskModal(this)">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State (Only if list is empty) -->
                <div class="col-12" th:if="${taskCreate == null or #lists.isEmpty(taskCreate)}">
                    <div class="empty-state-box">
                        <i class="bi bi-plus-square-dotted display-4 text-theme-muted opacity-50 mb-3 d-block"></i>
                        <h5 class="text-theme-heading">Nessuna task creata</h5>
                        <p class="text-theme-muted mb-3">Inizia organizzando il tuo lavoro oggi stesso.</p>
                        <button class="btn btn-theme-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">Crea Task</button>
                    </div>
                </div>
            </div>


            <!-- SECTION 2: TASK ASSEGNATE -->
            <div class="row mb-3 mt-5">
                <div class="col-12">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background-color: var(--bg-body-alt);">
                             <i class="bi bi-inbox-fill text-theme-heading fs-5"></i>
                        </div>
                        <h4 class="mb-0 fw-bold text-theme-heading">Assegnate a me</h4>
                        <span class="badge badge-theme-primary ms-3" th:text="${taskAssegnate != null ? taskAssegnate.size() : 0}">0</span>
                    </div>
                </div>
            </div>

            <!-- Grid: Task Assegnate -->
            <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3 g-xl-4 mb-5">
                <!-- Loop Items -->
                <div class="col" th:each="task : ${taskAssegnate}">
                    <div class="task-card" th:classappend="'priority-border-' + ${task.priorita}">
                        <div class="task-card-body">
                            <!-- Header -->
                            <div class="d-flex justify-content-between align-items-start gap-2">
                                <h5 class="fw-bold text-theme-heading text-truncate mb-0" th:title="${task.titolo}" th:text="${task.titolo}" style="max-width: 70%;">Title</h5>
                                
                                <span th:if="${task.priorita <= 2}" class="badge badge-theme-muted flex-shrink-0">Bassa</span>
                                <span th:if="${task.priorita == 3}" class="badge badge-theme-primary flex-shrink-0">Normale</span>
                                <span th:if="${task.priorita >= 4}" class="badge badge-theme-danger flex-shrink-0">Alta</span>
                            </div>

                            <!-- Assignee Context -->
                            <div class="d-flex align-items-center p-2 rounded-3 mt-3 mb-2 bg-theme-alt">
                                <div class="rounded-circle me-2 d-flex align-items-center justify-content-center flex-shrink-0" style="width: 32px; height: 32px; background-color: var(--color-primary); color: var(--color-white);">
                                    <span th:text="${#strings.substring(task.utenteCreatore.nome,0,1)}" class="fw-bold text-uppercase">U</span>
                                </div>
                                <div class="d-flex flex-column overflow-hidden">
                                    <span class="small text-theme-muted" style="font-size: 0.75rem; line-height: 1;">Assegnata da</span>
                                    <span class="fw-bold text-theme-heading text-truncate" th:text="${task.utenteCreatore.nome + ' ' + task.utenteCreatore.cognome}" style="font-size: 0.9rem;">Nome Cognome</span>
                                </div>
                            </div>

                            <!-- Dates -->
                            <div class="d-flex align-items-center text-theme-secondary small mt-2">
                                <i class="bi bi-calendar-check me-2"></i>
                                <span>Scadenza: <strong th:text="${task.scadenza != null ? #temporals.format(task.scadenza, 'dd/MM/yyyy') : 'Nessuna'}"></strong></span>
                            </div>

                            <!-- Spacer -->
                            <div class="flex-grow-1"></div>

                            <!-- Action -->
                            <div class="pt-3 mt-2 border-top" style="border-color: var(--border-color) !important;">
                                <form th:if="${task.dataCompletamento == null}" th:action="@{/dashboard/gtm/set-as-completato}" method="post" class="w-100">
                                    <input type="hidden" name="idTask" th:value="${task.id_task}">
                                    <button type="submit" class="btn btn-theme-primary w-100 btn-sm rounded-pill py-2">
                                        <i class="bi bi-check-lg me-1"></i> Segna Completata
                                    </button>
                                </form>
                                <button th:if="${task.dataCompletamento != null}" class="btn w-100 btn-sm rounded-pill py-2" disabled style="background-color: var(--bg-body-alt); color: var(--text-muted); border: 1px solid var(--border-color);">
                                    <i class="bi bi-archive-fill me-1"></i> Archiviata
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="col-12" th:if="${taskAssegnate == null or #lists.isEmpty(taskAssegnate)}">
                     <div class="empty-state-box">
                        <i class="bi bi-inbox display-4 text-theme-muted opacity-50 mb-3 d-block"></i>
                        <h5 class="text-theme-heading">Tutto pulito!</h5>
                        <p class="text-theme-muted">Non hai task assegnate al momento.</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-theme shadow-lg rounded-4">
            <form th:action="@{/dashboard/gtm}" method="post" th:object="${form}">
                <div class="modal-header modal-header-theme">
                    <h5 class="modal-title fw-bold text-theme-heading">Nuova Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modal-body-theme">
                    <!-- Form Fields -->
                    <div class="mb-3">
                        <label for="titolo" class="form-label fw-medium text-theme-secondary">Titolo</label>
                        <input type="text" class="form-control form-control-theme" id="titolo" name="titolo" th:value="*{titolo}" required minlength="2" maxlength="50" placeholder="Titolo breve..."
                               th:classappend="${#fields.hasErrors('titolo')} ? 'is-invalid'">
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('titolo')}" th:errors="*{titolo}"></div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label for="priorita" class="form-label fw-medium text-theme-secondary">Priorità</label>
                            <select class="form-select form-select-theme" id="priorita" name="priorita" th:value="*{priorita}"
                                    th:classappend="${#fields.hasErrors('priorita')} ? 'is-invalid'">
                                <option value="1" th:selected="*{priorita == 1}">Bassa</option>
                                <option value="2" th:selected="*{priorita == 2}">Medio-Bassa</option>
                                <option value="3" th:selected="*{priorita == 3}">Normale</option>
                                <option value="4" th:selected="*{priorita == 4}">Alta</option>
                                <option value="5" th:selected="*{priorita == 5}">Urgente</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('priorita')}" th:errors="*{priorita}"></div>
                        </div>
                        <div class="col-6">
                            <label for="scadenza" class="form-label fw-medium text-theme-secondary">Scadenza</label>
                            <input type="date" class="form-control form-control-theme" id="scadenza" name="scadenza" th:value="*{scadenza}"
                                   th:classappend="${#fields.hasErrors('scadenza')} ? 'is-invalid'">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('scadenza')}" th:errors="*{scadenza}"></div>
                        </div>
                    </div>
                    <!-- Assignees -->
                    <div class="mb-3">
                         <label class="form-label fw-medium text-theme-secondary">Assegna a</label>
                         <div id="add_selectedAssigneesList" class="d-flex flex-wrap gap-2 mb-2"></div>
                         <div class="position-relative">
                            <input type="text" class="form-control form-control-theme" id="add_searchAssignee" placeholder="Cerca nome..." autocomplete="off">
                            <div id="add_assigneeDropdown" class="list-group position-absolute w-100 shadow mt-1 overflow-auto rounded-3" style="max-height: 200px; z-index: 1050; display: none; background-color: var(--bg-light); border: 1px solid var(--border-color);"></div>
                        </div>
                        <div id="add_hiddenInputsContainer"></div>
                    </div>
                </div>
                <div class="modal-footer modal-footer-theme">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-theme-primary rounded-pill px-4">Salva</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-theme shadow-lg rounded-4">
            <form th:action="@{/dashboard/gtm/edit-task}" id ="modify_task" method="post" th:object="${editForm}">
                <input type="hidden" id="edit_idTask" name="idTask" th:value="*{idTask}">
                <div class="modal-header modal-header-theme">
                    <h5 class="modal-title fw-bold text-theme-heading">Modifica Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modal-body-theme">
                    <div class="mb-3">
                        <label for="edit_titolo" class="form-label fw-medium text-theme-secondary">Titolo</label>
                        <input type="text" class="form-control form-control-theme" id="edit_titolo" name="titolo" th:value="*{titolo}" required
                               th:classappend="${#fields.hasErrors('titolo')} ? 'is-invalid'">
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('titolo')}" th:errors="*{titolo}"></div>
                    </div>
                    <div class="row g-3 mb-3">
                         <div class="col-6">
                            <label for="edit_priorita" class="form-label fw-medium text-theme-secondary">Priorità</label>
                            <select class="form-select form-select-theme" id="edit_priorita" name="priorita" th:value="*{priorita}"
                                    th:classappend="${#fields.hasErrors('priorita')} ? 'is-invalid'">
                                <option value="1" th:selected="*{priorita == 1}">Bassa</option>
                                <option value="2" th:selected="*{priorita == 2}">Medio-Bassa</option>
                                <option value="3" th:selected="*{priorita == 3}">Normale</option>
                                <option value="4" th:selected="*{priorita == 4}">Alta</option>
                                <option value="5" th:selected="*{priorita == 5}">Urgente</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('priorita')}" th:errors="*{priorita}"></div>
                        </div>
                        <div class="col-6">
                            <label for="edit_scadenza" class="form-label fw-medium text-theme-secondary">Scadenza</label>
                            <input type="date" class="form-control form-control-theme" id="edit_scadenza" name="scadenza" th:value="*{scadenza}"
                                   th:classappend="${#fields.hasErrors('scadenza')} ? 'is-invalid'">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('scadenza')}" th:errors="*{scadenza}"></div>
                        </div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="edit_completato" name="completato" th:checked="*{completato}">
                        <label class="form-check-label text-theme-heading" for="edit_completato">Segna come completata</label>
                    </div>
                    <!-- Assignees Edit -->
                    <div class="mb-3">
                         <label class="form-label fw-medium text-theme-secondary">Assegnatari</label>
                         <div id="edit_selectedAssigneesList" class="d-flex flex-wrap gap-2 mb-2"></div>
                         <div class="position-relative">
                            <input type="text" class="form-control form-control-theme" id="edit_searchAssignee" placeholder="Cerca..." autocomplete="off">
                            <div id="edit_assigneeDropdown" class="list-group position-absolute w-100 shadow mt-1 overflow-auto rounded-3" style="max-height: 200px; z-index: 1050; display: none; background-color: var(--bg-light); border: 1px solid var(--border-color);"></div>
                        </div>
                        <div id="edit_hiddenInputsContainer"></div>
                    </div>
                </div>
                <div class="modal-footer modal-footer-theme">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-theme-primary rounded-pill px-4">Salva Modifiche</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Task Modal -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-theme shadow-lg rounded-4">
            <div class="modal-header modal-header-theme">
                <h5 class="modal-title fw-bold text-theme-heading">Elimina Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-body-theme">
                <p class="text-theme-body">Sei sicuro di voler eliminare la task <strong id="deleteTaskTitle" class="text-theme-heading"></strong>?</p>
                <div class="alert alert-danger d-flex align-items-center mb-0" role="alert" style="background-color: var(--bg-alert-danger); border-color: var(--border-alert-danger); color: var(--text-danger);">
                    <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                    <div>Questa azione è irreversibile.</div>
                </div>
            </div>
            <div class="modal-footer modal-footer-theme">
                <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">Annulla</button>
                <form th:action="@{/dashboard/gtm/delete-task}" method="post">
                    <input type="hidden" name="idTask" id="deleteTaskId">
                    <button type="submit" class="btn btn-danger rounded-pill px-4 shadow-sm">Elimina</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
function openDeleteTaskModal(button) {
    const id = button.getAttribute('data-id');
    const titolo = button.getAttribute('data-titolo');
    document.getElementById('deleteTaskId').value = id;
    document.getElementById('deleteTaskTitle').textContent = titolo;
    const modal = new bootstrap.Modal(document.getElementById('deleteTaskModal'));
    modal.show();
}

/* 
   Re-using the exact same logic but updated with CSS Variables for JS-created elements 
*/
class AssigneeManager {
    constructor(prefix) {
        this.prefix = prefix;
        this.searchInput = document.getElementById(prefix + '_searchAssignee');
        this.dropdown = document.getElementById(prefix + '_assigneeDropdown');
        this.selectedList = document.getElementById(prefix + '_selectedAssigneesList');
        this.hiddenInputsContainer = document.getElementById(prefix + '_hiddenInputsContainer');
        this.availableAssignees = []; 
        this.selectedAssignees = [];  
        this.init();
    }

    init() {
        this.searchInput.addEventListener('input', () => this.filterList());
        this.searchInput.addEventListener('focus', () => this.filterList());
        this.searchInput.addEventListener('click', () => this.filterList());
        document.addEventListener('click', (e) => {
            if (!this.searchInput.contains(e.target) && !this.dropdown.contains(e.target)) {
                this.dropdown.style.display = 'none';
            }
        });
    }

    loadData(data) { this.availableAssignees = data; }
    setSelection(selection) { this.selectedAssignees = selection ? [...selection] : []; this.updateUI(); }
    clearSelection() { this.selectedAssignees = []; this.updateUI(); }

    renderList(items) {
        this.dropdown.innerHTML = '';
        if (items.length === 0) {
            this.dropdown.style.display = 'none';
            return;
        }
        items.forEach(item => {
            if (this.selectedAssignees.some(s => s.id === item.id && s.type === item.type)) return;
            const a = document.createElement('a');
            a.className = 'list-group-item list-group-item-action d-flex align-items-center border-0 p-2';
            a.style.backgroundColor = 'var(--bg-light)';
            a.style.color = 'var(--text-body)';
            a.style.cursor = 'pointer';
            a.addEventListener('mouseenter', () => a.style.backgroundColor = 'var(--bg-body-alt)');
            a.addEventListener('mouseleave', () => a.style.backgroundColor = 'var(--bg-light)');
            const iconClass = item.type === 'utente' ? 'bi-person-fill' : 'bi-people-fill';
            a.innerHTML = `
                <div class="d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px; background-color: ${item.color || '#eee'}; border-radius: 50%;">
                    <i class="bi ${iconClass} text-white"></i>
                </div>
                <span>${item.nome}</span>
            `;
            a.addEventListener('click', (e) => { e.preventDefault(); this.addAssignee(item); });
            this.dropdown.appendChild(a);
        });
        this.dropdown.style.display = 'block';
    }
    
    filterList() {
        const query = this.searchInput.value.toLowerCase();
        let filtered = this.availableAssignees;
        if (query.length > 0) filtered = this.availableAssignees.filter(item => item.nome.toLowerCase().includes(query));
        this.renderList(filtered);
    }

    addAssignee(item) {
        this.selectedAssignees.push(item);
        this.updateUI();
        this.searchInput.value = '';
        this.searchInput.focus();
        this.dropdown.style.display = 'none';
    }

    removeAssignee(index) {
        this.selectedAssignees.splice(index, 1);
        this.updateUI();
    }

    updateUI() {
        this.selectedList.innerHTML = '';
        this.selectedAssignees.forEach((item, index) => {
            const chip = document.createElement('div');
            chip.className = 'd-flex align-items-center rounded-pill pe-2 ps-1 py-1 shadow-sm';
            chip.style.backgroundColor = 'var(--bg-white)';
            chip.style.border = '1px solid var(--border-color)';
            chip.style.color = 'var(--text-body)';
            const iconClass = item.type === 'utente' ? 'bi-person-fill' : 'bi-people-fill';
            chip.innerHTML = `
                <div class="d-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px; background-color: ${item.color || '#6c757d'}; border-radius: 50%;">
                    <i class="bi ${iconClass} text-white" style="font-size: 0.8rem;"></i>
                </div>
                <span class="me-2 fw-medium" style="font-size: 0.9rem;">${item.nome}</span>
                <button type="button" class="btn-close" style="font-size: 0.7em;" aria-label="Remove"></button>
            `;
            chip.querySelector('.btn-close').addEventListener('click', () => this.removeAssignee(index));
            this.selectedList.appendChild(chip);
        });
        this.hiddenInputsContainer.innerHTML = '';
        this.selectedAssignees.forEach((item, index) => {
            this.createHiddenInput(index, 'id', item.id);
            this.createHiddenInput(index, 'type', item.type);
            this.createHiddenInput(index, 'nome', item.nome);
            this.createHiddenInput(index, 'color', item.color);
            this.createHiddenInput(index, 'azienda', item.azienda);
        });
    }

    createHiddenInput(index, field, value) {
        if (value === undefined || value === null) return;
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = `messaggi[${index}].${field}`;
        input.value = value;
        this.hiddenInputsContainer.appendChild(input);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    let globalAssigneesData = [];
    const addManager = new AssigneeManager('add');
    const editManager = new AssigneeManager('edit');

    fetch('/dashboard/gtm/getusers', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            globalAssigneesData = data;
            addManager.loadData(data);
            editManager.loadData(data);
        })
        .catch(err => console.error('Error fetching assignees:', err));

    const addModal = document.getElementById('addTaskModal');
    addModal.addEventListener('show.bs.modal', function () {
        addManager.clearSelection();
        document.getElementById('add_searchAssignee').value = '';
    });

    if (document.querySelector('#addTaskModal .is-invalid')) {
        new bootstrap.Modal(addModal).show();
    }
    if (document.querySelector('#editTaskModal .is-invalid')) {
        new bootstrap.Modal(document.getElementById('editTaskModal')).show();
    }

    document.querySelectorAll('.btn-edit-task').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const titolo = this.getAttribute('data-titolo');
            const priorita = this.getAttribute('data-priorita');
            const scadenza = this.getAttribute('data-scadenza');
            const completato = this.getAttribute('data-completato') === 'true';
            let assignees = [];
            try { assignees = JSON.parse(this.getAttribute('data-assignees')); } catch (e) {}

            document.getElementById('edit_idTask').value = id;
            document.getElementById('edit_titolo').value = titolo;
            document.getElementById('edit_priorita').value = priorita;
            document.getElementById('edit_scadenza').value = scadenza;
            document.getElementById('edit_completato').checked = completato;
            editManager.setSelection(assignees);
        });
    });
});
</script>
</body>
</html>